# import matplotlib.pyplot as plt
import numpy as np
from scipy.optimize import curve_fit
from scipy.optimize import fsolve

# For function improcess(input):
#   Input: Array of 4D values e.g. np.shape(input) = (2100, 4)
#   Output: Array of 4D values in the same size, Bézier control points in format [x0,x1,x2,x3]


# Used by improcess() to perform per-channel denoising, Bézier fitting and quantization
def processchannel(inputchannel):
    sz = len(inputchannel)
    datadict = {(np.arange(0, sz))[i]: inputchannel[i] for i in np.arange(0, sz)}

    # Data editing
    dsorted = sorted(inputchannel)
    dsdiffs = [None]*(sz-1)
    for i in range(len(dsdiffs)):
        # print("{} {} {} {}".format(i, dsorted[i], dsorted[i+1], dsorted[i] - dsorted[i+1]))
        dsdiffs[i] = dsorted[i] - dsorted[i+1]
    # plt.plot(range(len(dsdiffs)), dsdiffs, '.', label='dsdiffs')

    windowsize = 10 # min 4ish
    absjump = [None]*(sz-1-windowsize)
    for i in range(len(absjump)):
        # print("absjump {} {} {}".format(i, dsorted[i], abs(sum(dsdiffs[i:i+windowsize])), sum(dsdiffs[i:i+windowsize])))
        absjump[i] = abs(sum(dsdiffs[i:i+windowsize]))
    # plt.plot(range(len(absjump)), absjump, '.', label='absjump')

    # Only try to remove noise if there's a big jump
    if max(absjump) > 15: # min 5
        # In the first half
        if absjump.index(max(absjump)) <= sz/2:
            snipindex = absjump.index(max(absjump)) + windowsize
            # print("snipindex <= sz/2: maxjump is {} at {} of value {}".format(max(absjump), snipindex, dsorted[snipindex]))
            for i in range(snipindex):
                for key in list(datadict.keys()):
                    if datadict[key] <= dsorted[snipindex]:
                        del datadict[key]
        # In the 2nd half
        else:
            snipindex = absjump.index(max(absjump))
            # print("snipindex > sz/2: maxjump is {} at {} of value {}".format(max(absjump), snipindex, dsorted[snipindex]))
            for i in range(snipindex):
                for key in list(datadict.keys()):
                    if datadict[key] > dsorted[snipindex]:
                        del datadict[key]


    # Fit and plot the noiseless curve to the sigmoid func
    def fsigmoid(x, a, b, c, d):
        return d / (1.0 + np.exp(-a * (x - b))) + c
    popt, pcov = curve_fit(fsigmoid, list(datadict.keys()), list(datadict.values()), method='dogbox', bounds=([-1., 0, 0, 0], [1., 1+sz, 1+max(inputchannel), 1+np.ptp(inputchannel)]))
    # print("Sigmoid parameters:\n\t{}".format(popt))

    # Use derivative of sigmoid to estimate control point placement
    handlex = 0
    slopefactor = 13
    threshold = popt[0]*popt[3]/(4*slopefactor)
    while 1 < threshold/(popt[0]*popt[3]*(np.e**(popt[0]*(handlex-popt[1])))/(np.e**(popt[0]*(handlex-popt[1]))+1)**2):
        handlex += 1
        # print("handlex = [{}, {:.0f}] w/ thresh {:.04f}/{:.04f}".format(handlex, 2*np.floor(popt[1])-handlex, (popt[0]*popt[3]*(np.e**(popt[0]*(handlex-popt[1])))/(np.e**(popt[0]*(handlex-popt[1]))+1)**2), threshold))

    # Return bézier control points (bcp) in format [x0,y0,...,x3,y3]
    x0 = handlex
    x1 = x2 = int(popt[1])
    x3 = min(2*x1-x0, sz-1)
    y0 = y1 = int(fsigmoid(x0, *popt))
    y2 = y3 = int(fsigmoid(x3, *popt))
    bcp = [x0, y0, x1, y1, x1, y2, x3, y3]
    # print("Béziers:\n\t0: [{}, {}]\n\t1: [{}, {}]\n\t2: [{}, {}]\n\t3: [{}, {}]".format(*bcp))

    # Bézier creation and quantization
    outputwb = np.array([None]*sz)
    for x in range(0, sz):
        if x < x0:
            outputwb[x] = y0
        if x0 <= x <= x3:
            def bezierinputx(t):
                return (1-t)*((1-t)*((1-t)*x0+t*x1)+t*((1-t)*x1+t*x2))+t*((1-t)*((1-t)*x1+t*x2)+t*((1-t)*x2+t*x3))-x
            t = fsolve(bezierinputx, 0.5)
            bezieroutputy = (1-t)*((1-t)*((1-t)*y0+t*y1)+t*((1-t)*y1+t*y2))+t*((1-t)*((1-t)*y1+t*y2)+t*((1-t)*y2+t*y3))
            # print("t: {}\ti: {}\tcorresponding y: {}".format(t, x, int(bezieroutputy)))
            outputwb[x] = int(bezieroutputy[0])
        if x > x3:
            outputwb[x] = y3

    return outputwb, bcp


# Input: Array of 4D values e.g. np.shape(input) = (2100, 4)
# Output: Array of 4D values in the same size, Bézier control points in format [x0,x1,x2,x3]
def improcess(inputbyimages):
    sz = len(inputbyimages)
    smoothchannels = [[None for i in range(sz)] for j in range(4)]
    bcps = [[None for i in range(sz)] for j in range(4)]
    bcpptps = [[None for i in range(sz)] for j in range(4)]
    returnbcpx = [[None for i in range(4)] for j in range(2)]

    inputbychannels = np.transpose(inputbyimages)
    for i in range(4):
        smoothchannels[i], bcps[i] = processchannel(inputbychannels[i])
        bcpptps[i] = np.ptp(bcps[i][1::2])
        # print("smoothchannel[{}] sz{} {}".format(i, len(smoothchannels[i]), smoothchannels[i]))
        # print("bcps[{}]:\n\t0: [{}, {}]\n\t1: [{}, {}]\n\t2: [{}, {}]\n\t3: [{}, {}]".format(i, *bcps[i]))
        # plt.plot(np.arange(0, sz), smoothchannels[i], '.')
        # plt.plot(bcps[i][::2], bcps[i][1::2], '+')
    # plt.show()

    # Find red and blue channels, take avg x position of BCPs
    for i in range(4):
        returnbcpx[0][i] = bcps[bcpptps.index(sorted(bcpptps)[2])][i*2]
        returnbcpx[1][i] = bcps[bcpptps.index(sorted(bcpptps)[3])][i*2]
        # print("returnbcp[{}] = avg of {} and {}".format(i, bcps[bcpptps.index(sorted(bcpptps)[2])][i*2], bcps[bcpptps.index(sorted(bcpptps)[3])][i*2]))

    print("Smoothed output curves:\n\tCh0: {}\n\tCh1: {}\n\tCh2: {}\n\tCh3: {}\nPer-channel peak-to-peaks: {}\nReturned Bézier control point x coordinates:\n\t{}".format(*smoothchannels, bcpptps, returnbcpx))
    return np.transpose(smoothchannels), returnbcpx

# Test input
# catwb1 = np.array([2756, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2736, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2752, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2596, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2600, 2436, 2524, 2536, 2544, 2532, 2536, 2536, 2536, 2536, 2540, 2548, 2548, 2552, 2548, 2548, 2548, 2548, 2548, 2548, 2548, 2548, 2556, 2548, 2544, 2548, 2560, 2544, 2548, 2468, 2552, 2552, 2552, 2552, 2552, 2552, 2552, 2560, 2564, 2568, 2536, 2580, 2572, 2588, 2472, 2576, 2580, 2588, 2448, 2456, 2588, 2456, 2444, 2612, 2612, 2468, 2500, 2504, 2484, 2484, 2472, 2488, 2484, 2476, 2504, 2500, 2676, 2664, 2504, 2676, 2668, 2668, 2488, 2696, 2516, 2632, 2548, 2620, 2628, 2556, 2600, 2404, 2552, 2684, 2684, 2576, 2584, 2584, 2588, 2584, 2600, 2664, 2656, 2656, 2656, 2656, 2656, 2612, 2560, 2568, 2632, 2588, 2588, 2588, 2660, 2636, 2556, 2644, 2520, 2640, 2636, 2500, 2504, 2640, 2472, 2472, 2652, 2436, 2436, 2632, 2400, 2620, 2648, 2420, 2760, 2636, 2652, 2636, 2636, 2640, 2636, 2628, 2632, 2620, 2636, 2636, 2632, 2612, 2604, 2628, 2620, 2592, 2596, 2676, 2416, 2560, 2604, 2600, 2608, 2608, 2588, 2544, 2524, 2600, 2604, 2592, 2580, 2600, 2708, 2568, 2604, 2592, 2600, 2580, 2496, 2572, 2596, 2572, 2592, 2592, 2544, 2528, 2564, 2568, 2568, 2568, 2564, 2564, 2576, 2552, 2552, 2560, 2572, 2540, 2556, 2544, 2580, 2548, 2532, 2544, 2544, 2548, 2556, 2552, 2540, 2540, 2208, 2540, 2532, 2548, 2540, 2544, 2528, 2556, 2540, 2528, 2536, 2536, 2552, 2536, 2552, 2528, 2520, 2524, 2532, 2512, 2508, 2512, 2520, 2484, 2412, 2472, 2500, 2532, 2192, 2504, 2200, 2200, 2508, 2496, 2168, 2188, 2188, 2520, 2536, 2200, 2520, 2480, 2192, 2492, 2192, 2180, 2520, 2516, 2512, 2200, 2504, 2508, 2200, 2496, 2512, 2488, 2508, 2504, 2196, 2196, 2492, 2484, 2204, 2496, 2496, 2168, 2516, 2524, 2520, 2504, 2196, 2204, 2204, 2508, 2508, 2512, 2496, 2196, 2476, 2212, 2192, 2192, 2520, 2204, 2500, 2200, 2516, 2164, 2196, 2492, 2516, 2196, 2196, 2512, 2492, 2204, 2208, 2484, 2472, 2208, 2492, 2196, 2496, 2188, 2500, 2196, 2200, 2200, 2200, 2480, 2124, 2508, 2188, 2200, 2200, 2200, 2484, 2196, 2200, 2200, 2200, 2500, 2508, 2204, 2208, 2208, 2516, 2512, 2200, 2504, 2204, 2508, 2512, 2204, 2512, 2508, 2200, 2504, 2496, 2512, 2168, 2492, 2196, 2192, 2192, 2472, 2148, 2144, 2144, 2144, 2492, 2516, 2188, 2516, 2508, 2516, 2172, 2520, 2492, 2200, 2468, 2136, 2172, 2172, 2172, 2172, 2516, 2488, 2204, 2196, 2480, 2196, 2200, 2492, 2196, 2204, 2204, 2204, 2204, 2204, 2204, 2204, 2204, 2500, 2488, 2124, 2088, 2500, 2192, 2200, 2516, 2200, 2200, 2496, 2192, 2472, 2180, 2492, 2196, 2196, 2196, 2196, 2196, 2196, 2196, 2196, 2472, 2476, 2476, 2204, 2492, 2492, 2164, 2192, 2492, 2492, 2504, 2492, 2480, 2480, 2160, 2188, 2188, 2480, 2192, 2200, 2200, 2200, 2500, 2188, 2200, 2476, 2496, 2192, 2480, 2488, 2168, 2188, 2188, 2188, 2188, 2492, 2504, 2500, 2192, 2192, 2504, 2216, 2216, 2216, 2460, 2176, 2500, 2192, 2500, 2512, 2504, 2500, 2168, 2504, 2200, 2200, 2200, 2500, 2036, 2196, 2196, 2196, 2196, 2196, 2512, 2200, 2520, 2508, 2196, 2192, 2524, 2204, 2504, 2508, 2204, 2204, 2204, 2204, 2204, 2508, 2204, 2516, 2196, 2492, 2504, 2204, 2508, 2204, 2204, 2204, 2496, 2200, 2196, 2196, 2488, 2204, 2204, 2204, 2504, 2516, 2500, 2168, 2192, 2484, 2188, 2492, 2192, 2488, 2512, 2500, 2204, 2528, 2200, 2504, 2196, 2512, 2520, 2504, 2180, 2128, 2428, 2500, 2200, 2196, 2112, 2492, 2204, 2200, 2492, 2440, 2460, 2472, 2516, 2516, 2488, 2504, 2180, 2196, 2196, 2196, 2516, 2504, 2204, 2204, 2204, 2460, 2488, 2168, 2452, 2200, 2468, 2496, 2200, 2484, 2172, 2424, 2136, 2480, 2200, 2488, 2464, 2244, 2232, 2232, 2380, 2140, 2464, 2204, 2204, 2204, 2468, 2200, 2208, 2208, 2484, 2204, 2204, 2496, 2456, 2200, 2204, 2204, 2204, 2476, 2492, 2204, 2208, 2208, 2496, 2176, 2484, 2204, 2160, 2172, 2460, 2168, 2204, 2476, 2468, 2176, 2460, 2468, 2196, 2484, 2208, 2472, 2200, 2200, 2460, 2192, 2464, 2176, 2464, 2468, 2200, 2200, 2460, 2200, 2204, 2204, 2204, 2204, 2204, 2452, 2244, 2452, 2172, 2448, 2476, 2480, 2472, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2464, 2168, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2200, 2464, 2196, 2200, 2460, 2168, 2196, 2196, 2196, 2196, 2484, 2468, 2468, 2160, 2196, 2196, 2196, 2196, 2476, 2488, 2196, 2460, 2168, 2484, 2464, 2200, 2464, 2480, 2464, 2480, 2152, 2460, 2472, 2476, 2480, 2480, 2204, 2200, 2484, 2476, 2484, 2204, 2204, 2204, 2204, 2468, 2476, 2164, 2436, 2200, 2200, 2200, 2200, 2200, 2452, 2200, 2468, 2204, 2204, 2484, 2200, 2484, 2196, 2448, 2200, 2196, 2444, 2464, 2504, 2204, 2472, 2164, 2200, 2200, 2200, 2472, 2472, 2212, 2476, 2492, 2200, 2484, 2488, 2496, 2484, 2172, 2492, 2484, 2200, 2492, 2196, 2196, 2496, 2200, 2452, 2148, 2488, 2176, 2484, 2484, 2488, 2484, 2204, 2496, 2160, 2472, 2208, 2476, 2484, 2192, 2192, 2192, 2468, 2184, 2184, 2184, 2184, 2480, 2164, 2468, 2200, 2196, 2492, 2196, 2504, 2164, 2196, 2320, 2476, 2468, 2176, 2200, 2484, 2200, 2200, 2472, 2492, 2208, 2488, 2492, 2496, 2496, 2212, 2208, 2208, 2488, 2196, 2200, 2480, 2200, 2508, 2464, 2464, 2196, 2200, 2200, 2200, 2496, 2492, 2492, 2492, 2164, 2476, 2200, 2204, 2204, 2204, 2484, 2488, 2488, 2204, 2204, 2496, 2208, 2512, 2200, 2196, 2496, 2192, 2496, 2496, 2472, 2480, 2204, 2512, 2476, 2500, 2200, 2200, 2488, 2200, 2200, 2500, 2512, 2488, 2488, 2504, 2204, 2492, 2204, 2496, 2200, 2200, 2200, 2200, 2492, 2452, 2140, 2148, 2492, 2488, 2200, 2200, 2504, 2488, 2204, 2508, 2208, 2200, 2488, 2172, 2516, 2172, 2196, 2196, 2196, 2196, 2488, 2320, 2180, 2488, 2496, 2204, 2480, 2204, 2200, 2200, 2200, 2496, 2196, 2196, 2512, 2172, 2488, 2204, 2204, 2204, 2204, 2500, 2508, 2212, 2492, 2172, 2200, 2200, 2200, 2200, 2496, 2492, 2204, 2204, 2224, 2216, 2508, 2172, 2460, 2176, 2204, 2484, 2096, 2480, 2192, 2196, 2196, 2488, 2488, 2424, 2180, 2180, 2180, 2180, 2488, 2200, 2444, 2168, 2484, 2196, 2500, 2172, 2200, 2492, 2212, 2488, 2204, 2460, 2224, 2460, 2508, 2200, 2500, 2200, 2476, 2500, 2492, 2204, 2200, 2492, 2504, 2500, 2204, 2488, 2488, 2504, 2200, 2492, 2496, 2204, 2204, 2204, 2488, 2500, 2208, 2472, 2204, 2204, 2204, 2496, 2484, 2176, 2200, 2484, 2500, 2204, 2484, 2176, 2200, 2484, 2516, 2204, 2504, 2504, 2200, 2204, 2476, 2484, 2204, 2504, 2192, 2492, 2492, 2472, 2484, 2496, 2212, 2216, 2216])
# catwb4 = np.array([1732, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1744, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1736, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1628, 1664, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1652, 1800, 1820, 1820, 1816, 1832, 1836, 1836, 1836, 1836, 1844, 1840, 1840, 1836, 1840, 1852, 1848, 1848, 1848, 1848, 1848, 1848, 1848, 1852, 1856, 1856, 1848, 1856, 1880, 1800, 1844, 1852, 1852, 1852, 1852, 1852, 1852, 1852, 1856, 1856, 1824, 1852, 1852, 1852, 1960, 1852, 1852, 1848, 1972, 1972, 1848, 1972, 1980, 1836, 1840, 1960, 1968, 1992, 1952, 1968, 1964, 1948, 1964, 1952, 1952, 1952, 1816, 1820, 1952, 1824, 1832, 1832, 1944, 1820, 1992, 1948, 2012, 1920, 1916, 2008, 1948, 1872, 1916, 1848, 1848, 1944, 1892, 1896, 1900, 1892, 1880, 1880, 1888, 1888, 1888, 1888, 1888, 1840, 1848, 1960, 1880, 1992, 1992, 1992, 1876, 1864, 2028, 1864, 2072, 1876, 1888, 2120, 2124, 1888, 2156, 2168, 1880, 2240, 2228, 1896, 2288, 1908, 1896, 2360, 1908, 1916, 1916, 1920, 1920, 1932, 1928, 1936, 1936, 1936, 1944, 1952, 1952, 1956, 1956, 1968, 1968, 1984, 1996, 2016, 2340, 2040, 1976, 1980, 2000, 2004, 2016, 1976, 1976, 2004, 2028, 2028, 2032, 2044, 2044, 2040, 2040, 2044, 2052, 2056, 2120, 2052, 2060, 2060, 2068, 2076, 2188, 2084, 2084, 2072, 2092, 2076, 2084, 2100, 2080, 2100, 2100, 2100, 2096, 2112, 2124, 2112, 2128, 2116, 2120, 2128, 2132, 2132, 2116, 2140, 2148, 2156, 2912, 2152, 2156, 2148, 2140, 2164, 2152, 2160, 2164, 2156, 2164, 2168, 2172, 2172, 2172, 2160, 2176, 2176, 2184, 2168, 2184, 2164, 2180, 2244, 2188, 2196, 2172, 2192, 2904, 2172, 2916, 2904, 2204, 2208, 2880, 2896, 2896, 2216, 2208, 2896, 2220, 2244, 2788, 2216, 2924, 2912, 2200, 2208, 2192, 2920, 2228, 2196, 2896, 2188, 2228, 2264, 2200, 2208, 2920, 2908, 2216, 2188, 2924, 2208, 2216, 2892, 2232, 2220, 2220, 2204, 2868, 2912, 2912, 2204, 2216, 2220, 2216, 2908, 2288, 2948, 2920, 2920, 2220, 2892, 2208, 2896, 2236, 2932, 2916, 2248, 2248, 2912, 2912, 2260, 2248, 2924, 2932, 2276, 2264, 2900, 2256, 2900, 2248, 2904, 2208, 2904, 2912, 2912, 2912, 2200, 2884, 2228, 2908, 2912, 2912, 2912, 2220, 2908, 2900, 2900, 2900, 2228, 2216, 2920, 2912, 2912, 2240, 2232, 2932, 2220, 2932, 2220, 2236, 2916, 2212, 2220, 2904, 2228, 2216, 2224, 2884, 2216, 2892, 2900, 2900, 2196, 2876, 2872, 2872, 2872, 2216, 2216, 2916, 2224, 2220, 2232, 2924, 2232, 2216, 2920, 2236, 2444, 2900, 2900, 2900, 2900, 2228, 2204, 2944, 2932, 2220, 2876, 2920, 2224, 2916, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2236, 2256, 2836, 2844, 2236, 2936, 2912, 2236, 2940, 2916, 2220, 2912, 2248, 2908, 2264, 2976, 2928, 2928, 2928, 2928, 2928, 2928, 2928, 2252, 2248, 2252, 2916, 2268, 2240, 2916, 2924, 2240, 2236, 2248, 2236, 2244, 2244, 2912, 2916, 2916, 2240, 2924, 2924, 2924, 2924, 2256, 2976, 2936, 2256, 2256, 2924, 2252, 2248, 2884, 2908, 2908, 2908, 2908, 2212, 2224, 2228, 2904, 2928, 2248, 2972, 2960, 2960, 2192, 2904, 2232, 2932, 2216, 2216, 2220, 2228, 2896, 2220, 2924, 2924, 2924, 2240, 2776, 2932, 2932, 2932, 2932, 2932, 2228, 2932, 2204, 2220, 2864, 2912, 2228, 2900, 2220, 2236, 2948, 2908, 2908, 2908, 2908, 2220, 2940, 2224, 2972, 2228, 2224, 2916, 2232, 2912, 2924, 2924, 2216, 2932, 2920, 2920, 2220, 2912, 2928, 2928, 2228, 2216, 2220, 2896, 2904, 2220, 2900, 2220, 2968, 2232, 2224, 2232, 2956, 2232, 2916, 2208, 2928, 2220, 2220, 2232, 2264, 2904, 2188, 2208, 2916, 2920, 2872, 2236, 2904, 2912, 2248, 2172, 2176, 2212, 2244, 2232, 2228, 2228, 2928, 2916, 2916, 2916, 2228, 2236, 2884, 2912, 2912, 2252, 2244, 2896, 2308, 2920, 2252, 2248, 2944, 2272, 2888, 2248, 2844, 2244, 2956, 2272, 2332, 2792, 2812, 2812, 2236, 2840, 2300, 2912, 2916, 2916, 2260, 2916, 2920, 2920, 2256, 2924, 2928, 2264, 2248, 2936, 2944, 2944, 2944, 2248, 2260, 2944, 2948, 2948, 2264, 2908, 2264, 2932, 2820, 2924, 2264, 2916, 2932, 2256, 2256, 2908, 2252, 2264, 2904, 2236, 2936, 2260, 2940, 2924, 2260, 2932, 2264, 2912, 2264, 2264, 2944, 2916, 2276, 2948, 2936, 2936, 2936, 2936, 2936, 2316, 2896, 2260, 2904, 2264, 2272, 2268, 2264, 2932, 2916, 2916, 2916, 2916, 2916, 2916, 2272, 2912, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2936, 2256, 2928, 2928, 2248, 2904, 2916, 2916, 2916, 2916, 2280, 2284, 2268, 2912, 2924, 2924, 2924, 2924, 2252, 2272, 2896, 2268, 2892, 2272, 2260, 2944, 2264, 2264, 2256, 2272, 2928, 2268, 2276, 2268, 2256, 2264, 2920, 2916, 2272, 2272, 2264, 2920, 2940, 2940, 2940, 2276, 2276, 2952, 2280, 2932, 2924, 2924, 2924, 2924, 2264, 2908, 2268, 2916, 2920, 2280, 2912, 2276, 2944, 2260, 2936, 2948, 2256, 2272, 2260, 2944, 2232, 2892, 2920, 2920, 2920, 2268, 2300, 2968, 2260, 2268, 2912, 2248, 2244, 2256, 2240, 2924, 2236, 2240, 2964, 2248, 2936, 2908, 2244, 2924, 2248, 2912, 2244, 2912, 2248, 2244, 2236, 2236, 2948, 2248, 2912, 2236, 2908, 2232, 2252, 2940, 2932, 2932, 2228, 2924, 2932, 2932, 2932, 2264, 2916, 2236, 2936, 2936, 2244, 2940, 2264, 2944, 2920, 2476, 2248, 2248, 2896, 2912, 2244, 2936, 2916, 2248, 2244, 2924, 2232, 2256, 2252, 2240, 2908, 2912, 2912, 2268, 2940, 2944, 2244, 2928, 2252, 2236, 2232, 2920, 2916, 2916, 2916, 2240, 2228, 2252, 2248, 2916, 2252, 2932, 2932, 2932, 2932, 2236, 2244, 2232, 2920, 2936, 2256, 2932, 2260, 2928, 2932, 2248, 2944, 2248, 2244, 2248, 2236, 2936, 2248, 2248, 2244, 2944, 2936, 2244, 2932, 2940, 2248, 2260, 2252, 2244, 2256, 2916, 2236, 2924, 2232, 2924, 2932, 2932, 2932, 2260, 2360, 2868, 2876, 2260, 2244, 2916, 2916, 2268, 2252, 2928, 2232, 2916, 2936, 2228, 2904, 2244, 2932, 2928, 2928, 2928, 2928, 2248, 2556, 2904, 2232, 2248, 2936, 2236, 2972, 2916, 2916, 2916, 2240, 2936, 2916, 2264, 2928, 2240, 2928, 2932, 2932, 2932, 2236, 2252, 2944, 2236, 2928, 2924, 2924, 2924, 2924, 2240, 2248, 2944, 2916, 2900, 2912, 2252, 2912, 2280, 2908, 2920, 2312, 2660, 2240, 2912, 2928, 2928, 2244, 2268, 2340, 2896, 2900, 2900, 2900, 2244, 2896, 2224, 2904, 2248, 2924, 2260, 2916, 2912, 2244, 2864, 2244, 2896, 2376, 2956, 2260, 2268, 2920, 2268, 2932, 2256, 2252, 2252, 2936, 2920, 2236, 2248, 2248, 2908, 2256, 2256, 2252, 2924, 2252, 2264, 2936, 2916, 2916, 2268, 2240, 2908, 2240, 2904, 2892, 2892, 2244, 2240, 2888, 2908, 2252, 2256, 2900, 2252, 2908, 2912, 2260, 2248, 2936, 2256, 2264, 2896, 2916, 2260, 2252, 2944, 2260, 2908, 2248, 2248, 2236, 2248, 2248, 2944, 2940, 2940])
# flat1 = np.array([1900]*2100)
# flat2 = np.array([2600]*2100)
# fourbyonebyn = np.transpose([catwb1, flat1, flat2, catwb4])
# improcess(fourbyonebyn)
